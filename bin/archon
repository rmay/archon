#!/usr/bin/env bash

ARCHON_VERSION=$(git -C ~/.local/share/archon describe --tags --abbrev=0 2>/dev/null)
PATH="$PATH:$HOME/.local/share/archon/bin"


show_archon_user_name() {
  echo "Welcome $ARCHON_USER_NAME" | tte  decrypt --typing-speed 2 --ciphertext-colors 008000 00cb00 00ff00 --final-gradient-stops eda000 --final-gradient-steps 12 --final-gradient-direction vertical
}

show_ascii_art() {
  clear
  tte -i ~/.local/share/archon/logo.txt --frame-rate 640 burn --burn-colors ffffff fff75d fe650d 8a003c 510100 --final-gradient-stops 00c3ff ffff1c --final-gradient-steps 12
  echo "                                                                          $ARCHON_VERSION"
  show_archon_user_name
}

main_menu() {
  show_ascii_art

  local options=("Theme" "Programming" "Terminal" "Setup" "Update" "Manual" "About" "Exit")
  choice=$(printf "%s\n" "${options[@]}" | gum choose --header "") || exit 0
  case "$choice" in
  Theme) theme_menu ;;
  Programming) programming_languages_menu ;;
  Terminal) terminal_menu ;;
  Update) update_menu ;;
  Setup) setup_menu ;;
  Manual) open_manual ;;
  About) archon-terminal -o font.size=9 -e bash -c 'fastfetch; read -n 1 -s' ;;
  Exit) clear && exit 0 ;;
  esac
}

update_menu() {
  show_ascii_art
  local menu=("Archon" "Desktop apps" "Back")
  local commands=(
    "archon-update"
    "archon-refresh-applications"
    "main_menu"
  )
  local choice
  choice=$(printf "%s\n" "${menu[@]}" | gum choose --header="Update") || main_menu
  for i in "${!menu[@]}"; do
    if [[ "${menu[$i]}" == "$choice" ]]; then
      if [[ "$choice" == "Back" ]]; then
        main_menu
      else
        eval "${commands[$i]}"
        ack_command
        main_menu
      fi
      break
    fi
  done
}

theme_menu() {
  show_ascii_art
  local menu=("Pick" "Back")
  local commands=(
    "archon-theme-menu"
    "main_menu"
  )
  local choice
  choice=$(printf "%s\n" "${menu[@]}" | gum choose --header="Theme") || main_menu
  for i in "${!menu[@]}"; do
    if [[ "${menu[$i]}" == "$choice" ]]; then
      if [[ "$choice" == "Back" ]]; then
        main_menu
      else
        eval "${commands[$i]}"
        ack_command
        main_menu
      fi
      break
    fi
  done
}

install_theme_prompt() {
  local url
  url=$(gum input --placeholder="Git repo URL for theme" --header="")
  if [[ -n "$url" ]]; then
    archon-theme-install "$url"
  fi
  theme_menu
}

remove_theme_prompt() {
  local theme
  theme=$(gum input --placeholder="Theme name" --header="")
  if [[ -n "$theme" ]]; then
    archon-theme-remove "$theme"
  fi
  theme_menu
}

setup_menu() {
  show_ascii_art
  local menu=("Docker DBs" "Back")
  local commands=(
    "setup_docker_dbs"
    "main_menu"
  )
  local choice
  choice=$(printf "%s\n" "${menu[@]}" | gum choose --header="Setup") || main_menu
  for i in "${!menu[@]}"; do
    if [[ "${menu[$i]}" == "$choice" ]]; then
      if [[ "$choice" == "Back" ]]; then
        main_menu
      else
        eval "${commands[$i]}"
        ack_command
        main_menu
      fi
      break
    fi
  done
}

setup_docker_dbs() {
  options=("MariaDB" "MySQL" "Redis" "PostgreSQL")
  choices=$(printf "%s\n" "${options[@]}" | gum choose --no-limit --header "Select databases (space to select, return to install, esc to cancel)") || main_menu

  if [[ -n "$choices" ]]; then
    for db in $choices; do
      case $db in
      MariaDB) sudo docker run -d --restart unless-stopped -p "127.0.0.1:3306:3306" --name=mariadb11 -e MARIADB_ROOT_PASSWORD= -e MARIADB_ALLOW_EMPTY_ROOT_PASSWORD=true mariadb:11.8 ;;
      MySQL) sudo docker run -d --restart unless-stopped -p "127.0.0.1:3306:3306" --name=mysql8 -e MYSQL_ROOT_PASSWORD= -e MYSQL_ALLOW_EMPTY_PASSWORD=true mysql:8.4 ;;
      Redis) sudo docker run -d --restart unless-stopped -p "127.0.0.1:6379:6379" --name=redis redis:7 ;;
      PostgreSQL) sudo docker run -d --restart unless-stopped -p "127.0.0.1:5432:5432" --name=postgres16 -e POSTGRES_HOST_AUTH_METHOD=trust postgres:16 ;;
      esac
    done
  fi

  main_menu
}

open_manual() {
  setsid chromium --new-window --ozone-platform=x11 --app="https://rmay.github.io/archon/" >/dev/null 2>&1 &
  clear
}

ack_command() {
  gum spin --spinner "globe" --title "Done!" -- sleep 1
}

programming_languages_menu() {
  show_ascii_art
  local menu=("Ruby" "Go Lang" "Java" "Squeak" "SBCL" "Back")
  local commands=(
    "archon-install-ruby"
    "archon-install-go"
    "archon-install-java"
    "archon-install-squeak"
    "archon-install-sbcl"
    "main_menu"
  )
  local choice
  choice=$(printf "%s\n" "${menu[@]}" | gum choose --header="Programming Languages") || main_menu
  for i in "${!menu[@]}"; do
    if [[ "${menu[$i]}" == "$choice" ]]; then
      if [[ "$choice" == "Back" ]]; then
        main_menu
      else
        eval "${commands[$i]}"
        ack_command
        main_menu
      fi
      break
    fi
  done
}

terminal_menu() {
  show_ascii_art
  local menu=("Ghostty" "Alacritty" "xterm" "st" "Back")
  local commands=(
    "archon-terminal-set ghostty"
    "archon-terminal-set alacritty"
    "archon-terminal-set xterm"
    "archon-terminal-set st"
    "main_menu"
  )
  local choice
  choice=$(printf "%s\n" "${menu[@]}" | gum choose --header="Programming Languages") || main_menu
  for i in "${!menu[@]}"; do
    if [[ "${menu[$i]}" == "$choice" ]]; then
      if [[ "$choice" == "Back" ]]; then
        main_menu
      else
        eval "${commands[$i]}"
        ack_command
        main_menu
      fi
      break
    fi
  done

}

main_menu
