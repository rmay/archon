#!/usr/bin/env bash

THEMES_DIR="$HOME/.config/archon/themes/"
CURRENT_THEME_DIR="$HOME/.config/archon/current/theme"
CURRENT_THEME_NAME=$(basename "$(realpath "$CURRENT_THEME_DIR")")

# Build themes list with pretty display names
mapfile -t themes < <(
  find "$THEMES_DIR" -mindepth 1 -maxdepth 1 \( -type d -o -type l \) | sort | while read -r path; do
    filename=$(basename "$path")
    display_name=$(echo "$filename" | sed -E 's/(^|-)([a-z])/\1\u\2/g; s/-/ /g')

    if [[ "$filename" == "$CURRENT_THEME_NAME" ]]; then
      echo "* $display_name"
    else
      echo "$display_name"
    fi
  done
)

# Prompt user with dmenu

selection=$(printf '%s\n' "${themes[@]}" | rofi -dmenu -i -p "Select Theme:")
[[ -z "$selection" ]] && exit 0  # User hit Esc or no selection

# Clean markup/prefix: "* Tokyo Night" -> "Tokyo Night"
clean_selection=$(echo "$selection" | sed -E 's/^\* //')

# Convert to lowercase and dash-separated: "Tokyo Night" -> "tokyo-night"
selected_theme=$(echo "$clean_selection" | tr '[:upper:]' '[:lower:]' | tr ' ' '-')

# Apply the selected theme
"$HOME/.local/share/archon/bin/archon-theme-set" "$selected_theme"
